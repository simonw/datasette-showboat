<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Showboat Document</title>
    <script src="{{ base_url }}-/static-plugins/datasette-showboat/marked.min.js"></script>
    <script src="{{ base_url }}-/static-plugins/datasette-showboat/purify.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #1f2328;
        }
        .chunk { margin-bottom: 0.5em; }
        .chunk-timestamp {
            font-size: 0.7em;
            color: #999;
            margin-bottom: 0.5em;
        }
        .chunk-content img { max-width: 100%; }
        .chunk-popped {
            opacity: 0.6;
        }
        .chunk-popped summary {
            cursor: pointer;
            font-size: 0.85em;
            color: #666;
            font-style: italic;
        }
        pre {
            background: #f6f8fa;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
        }
        code {
            background: #f6f8fa;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 85%;
        }
        pre code { background: none; padding: 0; }
        a { color: #0969da; }
        .nav { margin-bottom: 1em; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="nav"><a href="{{ base_url }}-/showboat">&larr; All documents</a></div>
    <div id="chunks"></div>
    <script>
    (function() {
        const uuid = {{ uuid|tojson }};
        const jsonUrl = {{ json_url|tojson }};
        let lastId = 0;
        const chunksDiv = document.getElementById("chunks");

        function detectImageType(base64Data) {
            // Detect image type from base64-encoded data by checking magic bytes
            const header = atob(base64Data.substring(0, 16));
            if (header.startsWith("\x89PNG")) return "image/png";
            if (header.startsWith("\xFF\xD8\xFF")) return "image/jpeg";
            if (header.startsWith("GIF8")) return "image/gif";
            if (header.startsWith("RIFF") && header.substring(8, 12) === "WEBP") return "image/webp";
            return "image/png";
        }

        function renderChunk(chunk) {
            const div = document.createElement("div");
            div.className = "chunk";
            div.setAttribute("data-id", chunk.id);

            if (chunk.command === "pop") {
                // Find the last visible (non-popped) chunk and wrap it
                const allChunks = chunksDiv.querySelectorAll(".chunk:not(.chunk-popped)");
                if (allChunks.length > 0) {
                    const target = allChunks[allChunks.length - 1];
                    target.classList.add("chunk-popped");
                    const originalContent = target.innerHTML;
                    target.innerHTML = "<details><summary>deleted</summary>" + originalContent + "</details>";
                }
                return;
            }

            const content = document.createElement("div");
            content.className = "chunk-content";
            let md = chunk.rendered_markdown || "";
            if (chunk.image) {
                const mimeType = detectImageType(chunk.image);
                const dataUri = "data:" + mimeType + ";base64," + chunk.image;
                if (md.match(/!\[[^\]]*\]\(\)/)) {
                    md = md.replace(/!\[([^\]]*)\]\(\)/, "![$1](" + dataUri + ")");
                } else {
                    md += "\n\n![image](" + dataUri + ")";
                }
            }
            content.innerHTML = DOMPurify.sanitize(marked.parse(md));

            const ts = document.createElement("div");
            ts.className = "chunk-timestamp";
            const date = new Date(chunk.created_at);
            ts.textContent = date.toLocaleString();

            div.appendChild(content);
            div.appendChild(ts);
            chunksDiv.appendChild(div);
        }

        async function poll() {
            try {
                const url = jsonUrl + (lastId ? "?after=" + lastId : "");
                const response = await fetch(url);
                if (!response.ok) return;
                const data = await response.json();
                if (data.chunks && data.chunks.length > 0) {
                    data.chunks.forEach(function(chunk) {
                        renderChunk(chunk);
                        if (chunk.id > lastId) lastId = chunk.id;
                    });
                }
            } catch (e) {
                console.error("Poll error:", e);
            }
        }

        poll();
        setInterval(poll, 2000);
    })();
    </script>
</body>
</html>
